name: Instagram Video Downloader

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Instagram username (without @)'
        required: true
        default: 'cristiano'

jobs:
  scrape-and-send:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: pip install requests
    
    - name: Scrape and Send Videos
      run: |
        python3 << 'PYTHON_SCRIPT'
        import requests
        import json
        import time
        
        # Configuration
        TELEGRAM_BOT_TOKEN = "8466011068:AAEmZ-PgnF6QcrhRNNxINvS7P48mIiQMKHw"
        CHAT_ID = "1034234267"
        USERNAME = "${{ github.event.inputs.username }}"
        
        def send_telegram(text):
            url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
            requests.post(url, json={'chat_id': CHAT_ID, 'text': text, 'parse_mode': 'HTML'})
        
        def send_video(video_url, caption):
            url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendVideo"
            try:
                response = requests.post(url, json={
                    'chat_id': CHAT_ID,
                    'video': video_url,
                    'caption': caption,
                    'parse_mode': 'HTML'
                }, timeout=60)
                return response.status_code == 200
            except:
                return False
        
        # Notify start
        send_telegram(f"ðŸ”„ Scraping Instagram: @{USERNAME}\nâ³ Please wait...")
        
        # Method 1: Try Instaloader API
        try:
            # Using public Instagram endpoints
            url = f"https://www.instagram.com/api/v1/users/web_profile_info/?username={USERNAME}"
            headers = {
                'User-Agent': 'Instagram 76.0.0.15.395 Android',
                'X-IG-App-ID': '936619743392459'
            }
            
            response = requests.get(url, headers=headers, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                user_data = data.get('data', {}).get('user', {})
                
                if user_data:
                    # Get user ID
                    user_id = user_data.get('id')
                    full_name = user_data.get('full_name', USERNAME)
                    followers = user_data.get('edge_followed_by', {}).get('count', 0)
                    
                    send_telegram(
                        f"âœ… Found: {full_name}\n"
                        f"ðŸ‘¥ Followers: {followers:,}\n"
                        f"ðŸ”— https://instagram.com/{USERNAME}\n\n"
                        f"âš ï¸ Instagram API requires authentication for video downloads.\n\n"
                        f"ðŸ“ Alternative: I can help you set up Bhindi Instagram Scraper API for automatic downloads!"
                    )
                else:
                    send_telegram(f"âŒ Could not find profile: @{USERNAME}")
            else:
                send_telegram(f"âš ï¸ Instagram API returned status: {response.status_code}")
                
        except Exception as e:
            send_telegram(f"âŒ Error: {str(e)}\n\nðŸ’¡ Please provide Bhindi API key for full functionality!")
        
        PYTHON_SCRIPT
